<audio id="song" src="{{ "audio/cancion.mp3" | relURL }}" preload="auto" autoplay muted loop></audio>

<button id="music-toggle" aria-label="Reproducir música" class="music-btn" type="button">
  <span class="music-icon" aria-hidden="true">♪</span>
</button>

<script>
(function () {
  const audio = document.getElementById('song');
  const btn = document.getElementById('music-toggle');

  function setState(playing) {
    btn.classList.toggle('playing', playing);
    btn.setAttribute('aria-label', playing ? 'Pausar música' : 'Reproducir música');
  }

  // Primer toque en la página: desmutea y reproduce
  function enableSoundOnce() {
    audio.muted = false;
    audio.play().then(() => setState(true)).catch(()=>{});
    document.removeEventListener('click', enableSoundOnce, { capture: true });
    document.removeEventListener('touchstart', enableSoundOnce, { capture: true });
  }
  document.addEventListener('click', enableSoundOnce, { capture: true, once: true });
  document.addEventListener('touchstart', enableSoundOnce, { capture: true, once: true });

  // Toggle play/pause
  btn.addEventListener('click', function (e) {
    e.stopPropagation();
    if (audio.paused) {
      audio.muted = false;
      audio.play().then(() => setState(true)).catch(()=>{});
    } else {
      audio.pause();
      setState(false);
    }
  });

  // Actualiza icono si el usuario usa controles del sistema
  audio.addEventListener('play', () => setState(true));
  audio.addEventListener('pause', () => setState(false));
})();
</script>
